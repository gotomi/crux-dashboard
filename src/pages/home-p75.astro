---
import Layout from '../layouts/Layout.astro'

// Component Imports
import Header from '../components/Header.astro';
import Table from '../components/Table.astro';

let title = 'CrUX Dashboard - p75';

import data from '../_data/crux-home.json';


function allGoodPercent() {
    const minimal = {};
    data.metrics.forEach(item => {
        const v = Object.values(item);
        const allMin = v.map(item => typeof item === 'object' ? item.histogram[0] : 2000).reduce((a,b) => Math.min(a,b));
        minimal[item.url] = allMin;
    }
    );
    return minimal;
}

function compareByMinimal(a,b) {
        const y = a[0].minimal;
        const x = b[0].minimal;
        if (y > x ) return -1
        if (x < y ) return 1
        return 0;
}

function getMetric() {
    const minimal = allGoodPercent()
    
    return data.metrics.map(item => {
    let obj = [];
    obj.push({url: item.url.replace("https://",""), minimal:minimal[item.url]});
    [" FCP", " LCP", " FID", " CLS"].forEach(metric => {
         obj.push({p75:item[metric].p75, rank: item[metric].rank});
    })
    return obj
    }).sort(compareByMinimal)

}
const table = [["url", "FCP", "LCP", "FID", "CLS"]].concat(getMetric());
---
<Layout title = {title}>
    <main>
        <header>
            <div>
                <h1>{title}</h1>
                <Header params={data.params}/>
            </div>
        </header>
        <section>
            <article>
                <Table table={table}/>
            </article>
        </section>
    </main>
</Layout>